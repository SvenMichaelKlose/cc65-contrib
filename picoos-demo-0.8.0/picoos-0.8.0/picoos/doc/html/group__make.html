<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pico]OS: Make Environment</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>Make Environment<br>
<small>
[<a class="el" href="group__intro.html">Introduction</a>]</small>
</h1><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
</table>
<h3>Introduction </h3>
<p>
pico]OS comes with a powerful make environment based on GNU Make. The make files are universal to all target platforms and most compilers. They are the first step to platform independent software developement. <br>
<p>
The core files of the make environment are located in the subdirectory <code>picoos/make</code>. The main makefile for pico]OS is stored in the pico]OS root directory, and every platform port comes with a makefile that teaches the platform dependent environment to the make system. <br>
<p>
The makefiles were tested with GNU make 3.80 <br>
<p>
<br>
 <h3>Compiling pico]OS </h3>
<p>
To compile the pico]OS library, you need to execute the makefile in the pico]OS root directory. The makefile knows three targets, that are: <br>
<p>
<ul>
<li><code>all</code> builds the pico]OS library</li><li><code>clean</code> deletes all binaries generated by previous make run</li><li><code>docu</code> builds the documentation using the doxygen tool</li></ul>
<p>
The targets <code>all</code> and <code>clean</code> need the additional parameter <code>PORT</code> that specifies the destination port. For example, a valid make call would look like this (at the DOS prompt): <br>
<p>
<div class="fragment"><pre>C:\picoos-0.7.0&gt; gmake all PORT=6502
</pre></div><p>
This will build pico]OS for the 6502 processor family. After the successful execution of make you will find two new subdirectories: The <code>obj</code> directory contains all generated object files, and the <code>lib</code> directory the final library. <br>
<p>
There is a second option available on the command line: <code>BUILD=DEBUG</code> would build a debug version of the operating system, and a <code>BUILD=RELEASE</code> would build a release version. Note that the debug version is the default when this option is not given. <br>
<p>
<b>Note</b>: The name of the port is the name of its subdirectory in the <code>ports</code> directory. <br>
<p>
<br>
 <h3>Building An Application </h3>
<p>
The pico]OS library is only the first step to an executable. The make environment supports also the linking of object files and libraries to get an executable. For example, you have written a 'hello world' program that uses pico]OS. To compile and link the file <code>hello.c</code> you need to perform the following steps: <br>
<p>
<ul>
<li>create a subdirectory somewhere in the <code>picoos</code> directory tree</li><li>place your file <code>hello.c</code> in this directory</li><li>generate and place a makefile in the same directory. The makefile should look like this:</li></ul>
<p>
<div class="fragment"><pre>01  #
02  # This makefile compiles hello.c and generates an executable
03  #
04
05  # This test program shall be compiled <span class="keywordflow">for</span> the 6502 port
06  PORT = 6502
07
08  # Set build mode (DEBUG or RELEASE)
09  BUILD = DEBUG
10
11  # To include the pico]OS nano layer, set <span class="keyword">this</span> define to 1
12  NANO = 0
13
14  # Set relative path to the picoos root directory and include base make file
15  RELROOT = ../../../
16  include $(RELROOT)make/common.mak
17
18  # --------------------------------------------------------------------------
19
20  # Set target file name
21  TARGET = hello
22
23  # Set source files
24  SRC_TXT = hello.c
25  SRC_OBJ =
26  SRC_LIB =
27
28  # Set the directory that contains the configuration header files
29  DIR_CONFIG =
30
31  # ---------------------------------------------------------------------------
32
33  # Build an executable
34  include $(MAKE_OUT)
</pre></div><p>
The lines 15, 16, 21, 24 and 34 are mandatory. The <code>PORT</code> variable may also be set at the command line when make is invoked, even like the <code>BUILD</code> mode. <code>RELROOT</code> sets the relative way to the pico]OS root directory. In line 12 you can enable the nano layer of pico]OS that is available with pico]OS 0.8.0. Line 16 includes the main makefile of the make environment. Line 18 sets the name of the executable to generate. Note that only the basename must be specified, in our example the executable <code>hello.c64</code> will be generated. Lines 24 to 26 set the source files that shall be linked to the pico]OS library. <code>SRC_TXT</code> specifies a list of sourcecode files (in textual form). <code>SRC_OBJ</code> and <code>SRC_LIB</code> specify a list of existing object files and libraries that shall be linked to the executable. If your application uses an other configuration than the default, you can place your own configuration files <code><a class="el" href="poscfg_8h.html">poscfg.h</a></code> and <code><a class="el" href="noscfg_8h.html">noscfg.h</a></code> into your project directory. You must then set <code>DIR_CONFIG</code> (line 29) to the place where the configuration files are located. Note that this path is absolute to the pico]OS root, so if your project directory is <code>picoos-0.7.0/myproject</code>, you would set <code>DIR_CONFIG = myproject</code>. Finally, the line 34 includes the makefile that starts the build process. <br>
 To build your application, simply invoke make with the target <code>all</code> to generate the executable. The executable is then stored in the directory <code>picoos-0.7.0/out</code>. The makefile supports also the target <code>clean</code> that cleans your last build again. <br>
<p>
<br>
 <h3>Format Of File port.mak </h3>
<p>
Each platform port need to have a special version of the file port.mak. This file is used to tell the make environment the settings needed to compile files for the platform. This settings include: The compiler / linker / archiver to use, runtime libraries to link to the exectuable, file extension names, and various port specific settings. Here is an example how the file <code>port.mak</code> may look like: <br>
<p>
<div class="fragment"><pre>01  #
02  # port.mak <span class="keywordflow">for</span> the 6502 port
03  #
04  
05  # Compiler: Define place of compiler
06  CC65 = h:/cc65
07  
08  # Compiler: Define target type
09  TG = c64
10  
11  # Set to 1 to include generic pico]OS <span class="stringliteral">"findbit"</span> function
12  GENERIC_FINDBIT = 0
13  
14  # Define extensions
15  EXT_C   = .c
16  EXT_ASM = .s
17  EXT_OBJ = .o
18  EXT_LIB = .lib
19  EXT_OUT = .$(TG)
20  
21  # Define tools: compiler, assembler, archiver, linker
22  CC = $(CC65)/bin/cc65
23  AS = $(CC65)/bin/ca65
24  AR = $(CC65)/bin/ar65
25  LD = $(CC65)/bin/ld65
26  
27  # Define to 1 <span class="keywordflow">if</span> CC outputs an assembly file
28  CC2ASM = 1
29  
30  # Define general options
31  OPT_CC_INC   = -I
32  OPT_CC_DEF   = -D
33  OPT_AS_INC   = -I
34  OPT_AS_DEF   = -D
35  OPT_AR_ADD   =
36  OPT_LD_SEP   = 
37  OPT_LD_PFOBJ = 
38  OPT_LD_PFLIB = 
39  OPT_LD_FIRST = $(CC65)/lib/$(TG).o
40  OPT_LD_LAST  = $(CC65)/lib/$(TG).lib
41  
42  # Set global defines <span class="keywordflow">for</span> compiler / assembler
43  CDEFINES =
44  ADEFINES =
45  
46  # Set global includes
47  CINCLUDES = $(CC65)\include .
48  AINCLUDES = $(CC65)\include .
49  
50  # Distinguish between build modes
51  ifeq '$(BUILD)<span class="charliteral">' '</span>DEBUG'
52    CFLAGS   += -g
53    AFLAGS   += -g
54    CDEFINES += _DBG
55    ADEFINES += _DBG
56  <span class="keywordflow">else</span>
57    CDEFINES += _REL
58    ADEFINES += _REL
59  endif
60  
61  # Define Compiler Flags
62  CFLAGS += -t $(TG) -O -A -T -o 
63  
64  # Define Assembler Flags
65  ASFLAGS += -t $(TG) -o 
66  
67  # Define Linker Flags
68  LDFLAGS = -t $(TG) -Ln $(DIR_OUT)/$(TARGET).lbl -m $(DIR_OUT)/$(TARGET).map -o 
69  
70  # Define archiver flags
71  ARFLAGS = a 
</pre></div><p>
The lines 12, 15 - 19, 22 - 25, 28, 31 - 40, 54 - 55, 57 - 58, 62, 65, 68 and 71 are mandatory. If <code>GENERIC_FINDBIT</code> (line 12) is enabled (= set to 1), the file fbit_gen.c is compiled and linked to the pico]OS library. Some compilers need a special handling to compile C-files. If <code>CC2ASM</code> is set to 1, the make system will first generate assembly files from C source files before generating the final object file from the intermediate assembly file. <hr size="1"><address style="align: right;"><small>Generated on Sun Mar 21 20:37:33 2004 for pico]OS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
